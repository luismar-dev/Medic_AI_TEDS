<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pantalla de Inicio</title>
    <link rel="stylesheet" href="inicio.css" />
    <style>
      .seccion-medica {
        padding: 8px;
        background: #7c3aad;
        border-radius: 8px;
      }

      .seccion-titulo {
        font-weight: bold;
        font-size: 16px;
        color: #ffffff;
        margin-bottom: 2px;
        padding: 10px;
        padding-bottom: 8px;
        background-color: #7c3aad;
        border-radius: 6px;
        border-bottom: none;
      }

      .seccion-contenido {
        font-size: 14px;
        line-height: 1.6;
        color: #ffffff;
        padding-left: 8px;
        padding-top: 8px;
        white-space: pre-wrap;
      }

      .message.received {
        max-width: 80%;
        padding: 15px;
        background-color: #7c3aad;
        border-radius: 12px;
      }
    </style>
  </head>

  <body>
    <div class="overlay" id="overlay">
      <div class="anuncio">
        <div class="header_aviso">
          <img
            class="aviso_image"
            src="https://raw.githubusercontent.com/luismar-dev/Medic_AI_TEDS/33f7acfffc898e8fcd58ca74b699b1d5f4a64c28/project/modal_aviso_img.png"
            alt="aviso_img"
          />
          <h2>Aviso Importante</h2>
        </div>

        <p id="mensajeAnuncio">
          Este sistema solo atiende consultas relacionadas con infecciones
          respiratorias agudas.
        </p>
        <button class="btn-aceptar" onclick="cerrarAnuncio()">
          Entendido y continuar
        </button>
      </div>
    </div>
    <div class="main-container">
      <div class="logo-title">
        <img
          class="logo-image"
          src="https://raw.githubusercontent.com/luismar-dev/Medic_AI_TEDS/33f7acfffc898e8fcd58ca74b699b1d5f4a64c28/project/logo_Medic_AI.png"
          alt="Ícono de salud"
        />
        <img
          src="https://raw.githubusercontent.com/luismar-dev/Medic_AI_TEDS/33f7acfffc898e8fcd58ca74b699b1d5f4a64c28/project/nombre_Medic_AI.png"
          alt="Medic-AI"
        />
      </div>

      <div class="sidebar"></div>

      <div class="content-box"></div>
      <div class="cuadro-perfil">
        <div class="user-profile">
          <img src="" alt="Avatar de usuario" />
          <span>nombre</span>
        </div>
      </div>
      <div class="prompt">
        <input type="text" id="texto" placeholder="Describe tus sintomas" />
        <button class="send-btn" id="btnEnviar" aria-label="Enviar">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M12 19V5M12 5L5 12M12 5L19 12"
              stroke="#000000"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>
  </body>

  <script>
    function cerrarAnuncio() {
      const overlay = document.getElementById("overlay");
      overlay.classList.add("hidden");
    }

    function mostrarAnuncio(mensaje) {
      const overlay = document.getElementById("overlay");
      const mensajeAnuncio = document.getElementById("mensajeAnuncio");

      // Cambiar el mensaje si se proporciona uno
      if (mensaje) {
        mensajeAnuncio.textContent = mensaje;
      }

      // Mostrar el overlay
      overlay.classList.remove("hidden");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const userEmail = localStorage.getItem("currentUserEmail");

      if (!userEmail) {
        console.error("No hay un usuario logueado.");
        // Agregar para forzar el login si no hay usuario
        // window.location.href = 'sesion.html';
        return;
      }

      try {
        // Pedimos los datos del usuario al servidor
        const response = await fetch(
          "http://127.0.0.1:5000/api/get-user-data",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: userEmail }),
          }
        );

        const data = await response.json();

        if (response.ok) {
          const nombreCompleto = data.nombre;
          const partesNombre = nombreCompleto.split(" ");
          const nombreMostrado = `${partesNombre[0]} ${
            partesNombre[1] || ""
          }`.trim();

          const userNameElement = document.querySelector(".user-profile span");
          const userAvatarElement = document.querySelector(".user-profile img");

          if (userNameElement) {
            userNameElement.textContent = nombreMostrado;
          }

          if (userAvatarElement) {
            userAvatarElement.src = `https://ui-avatars.com/api/?name=${nombreMostrado}&background=A057D5&color=fff&size=40&rounded=true`;
          }
        } else {
          console.error("Error al obtener los datos del usuario:", data.error);
        }
      } catch (error) {
        console.error("Error de conexión al obtener datos del usuario:", error);
      }
    });
  </script>

  <script>
    const sendButton = document.querySelector(".send-btn");
    const messageInput = document.getElementById("texto");
    const chatWindow = document.querySelector(".content-box");
    const errorMessage = document.getElementById("errorMessage");

    // Variables globales para controlar el estado del botón
    let promptBloqueado = false;
    let textoOriginalInvalido = "";

    // Caracteres permitidos
    const notAllowedCharsRegex = /[^a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ %!¡¿?\-_.,;()\s]/g;

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
    }

    function hideError() {
      errorMessage.textContent = "";
      errorMessage.style.display = "none";
    }

    messageInput.addEventListener("input", function () {
      let filteredText = this.value.replace(notAllowedCharsRegex, "");

      if (this.value !== filteredText) {
        this.value = filteredText;
      }

      // Limita a 750 caracteres
      if (this.value.length > 750) {
        this.value = this.value.substring(0, 750);
        showError("Has alcanzado el límite de 750 caracteres.");
      } else {
        hideError();
      }

      // Si el prompt estaba bloqueado y el texto cambió, habilitar botón
      if (promptBloqueado) {
        const textoActual = this.value.trim();

        // Solo habilitar si el texto es diferente al inválido y no está vacío
        if (textoActual !== textoOriginalInvalido && textoActual.length > 0) {
          promptBloqueado = false;
          sendButton.disabled = false;
          sendButton.style.opacity = "1";
          sendButton.style.cursor = "pointer";
          hideError();
        }
      }
    });

    function formatearRespuestaMedica(texto, graficoUrl = null) {
      // Palabras clave para detectar secciones
      const secciones = [
        { key: "diagnóstico", label: "Diagnóstico" },
        { key: "gravedad", label: "Gravedad" },
        { key: "explicación", label: "Explicación" },
        { key: "recomendaciones médicas", label: "Recomendaciones Médicas" },
      ];

      let textoHTML = "";
      let restoTexto = texto;

      secciones.forEach((seccion, index) => {
        // Buscar la palabra clave (case insensitive)
        const regex = new RegExp(
          `(${seccion.key}[:\\s-]*)([\\s\\S]*?)(?=(${secciones
            .map((s) => s.key)
            .join("|")}[:\\s-])|$)`,
          "i"
        );
        const match = restoTexto.match(regex);

        if (match && match[2] && match[2].trim()) {
          textoHTML += `
        <div class="seccion-medica">
          <div class="seccion-titulo">${seccion.label}</div>
          <div class="seccion-contenido">${match[2].trim()}</div>
      `;

          // Si es la sección de Gravedad Y hay gráfico, agregarlo aquí
          if (seccion.key === "gravedad" && graficoUrl) {
            textoHTML += `
          <img 
            src="http://127.0.0.1:5000${graficoUrl}" 
            alt="Gráfico de gravedad" 
            style="max-width: 300px; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block;"
          />
        `;
          }

          textoHTML += `</div>`; // Cerrar seccion-medica

          // Remover la sección ya procesada
          restoTexto = restoTexto.replace(match[0], "");
        }
      });

      // Si no se encontraron secciones, retornar el texto original
      return textoHTML || texto;
    }

    function displayChatMessage(
      text,
      type,
      showLoadingGif = false,
      graficoUrl = null
    ) {
      const messageElement = document.createElement("div");
      messageElement.classList.add("message", type);

      if (showLoadingGif) {
        messageElement.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <img 
          src="https://raw.githubusercontent.com/luismar-dev/Medic_AI_TEDS/33f7acfffc898e8fcd58ca74b699b1d5f4a64c28/project/imagencarga.gif" 
          alt="Cargando..." 
          style="width: 28px; height: 28px; border-radius: 50%;"
        />
        <span style="flex: 1;">${text}</span>
      </div>
    `;
      } else {
        // Si es una respuesta recibida (del médico), formatearla
        if (type === "received") {
          const textoFormateado = formatearRespuestaMedica(text, graficoUrl);
          messageElement.innerHTML = textoFormateado;
        } else {
          messageElement.textContent = text;
        }

        // Agregar advertencia obligatoria al final (solo para mensajes recibidos)
        if (type === "received" && !showLoadingGif) {
          const advertenciaElement = document.createElement("div");
          advertenciaElement.style.marginTop = "15px";
          advertenciaElement.style.backgroundColor = "#7c3aad";
          advertenciaElement.style.color = "#ffffff";
          advertenciaElement.style.fontSize = "13px";
          advertenciaElement.style.fontWeight = "bold";
          advertenciaElement.innerHTML =
            "⚠️ Advertencia obligatoria:<br>Este diagnóstico es orientativo. Se recomienda acudir a un médico general para una evaluación profesional";
          messageElement.appendChild(advertenciaElement);
        }
      }

      chatWindow.appendChild(messageElement);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return messageElement;
    }

    async function sendMessage() {
      const messageText = messageInput.value.trim();
      const userEmail = localStorage.getItem("currentUserEmail");

      console.log("🔹 sendMessage ejecutada"); // DEBUG
      console.log("📝 Texto:", messageText); // DEBUG

      // Validar que no esté vacío
      if (!messageText || messageText.length === 0) {
        showError("⚠️ Por favor, describe tus sintomas antes de enviar.");
        return;
      }

      // Si el botón está bloqueado, no permitir envío
      if (promptBloqueado) {
        showError("⚠️ Debes modificar tu consulta antes de enviar.");
        return;
      }

      hideError();
      displayChatMessage(messageText, "sent");

      // Guardar el texto antes de limpiar
      const textoEnviado = messageText;
      messageInput.value = "";

      if (!userEmail) {
        showError("No se ha podido identificar al usuario.");
        return;
      }

      const loadingMessage = displayChatMessage(
        "Evaluando y analizando síntomas...",
        "received",
        true
      );

      try {
        const response = await fetch("http://127.0.0.1:5000/api/send-prompt", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sintomas: textoEnviado, email: userEmail }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || "Error del servidor");
        }

        if (loadingMessage && loadingMessage.parentNode) {
          loadingMessage.remove();
        }

        if (data.success && data.respuesta) {
          // VERIFICAR SI ES PROMPT INVÁLIDO
          if (data.prompt_invalido === true) {
            // Bloquear el botón
            promptBloqueado = true;
            textoOriginalInvalido = textoEnviado;
            sendButton.disabled = true;
            sendButton.style.opacity = "0.5";
            sendButton.style.cursor = "not-allowed";

            // Mostrar error visible
            showError(
              "⚠️ Debes describir síntomas respiratorios. Modifica tu consulta."
            );

            // Mostrar el anuncio nuevamente
            mostrarAnuncio(
              "Este sistema solo atiende consultas relacionadas con infecciones respiratorias agudas. Por favor, describe síntomas respiratorios."
            );
          }

          // Mostrar respuesta en el chat con gráfico si existe
          displayChatMessage(
            data.respuesta,
            "received",
            false,
            data.grafico_url || null
          );
        } else {
          showError("No se recibió respuesta del servidor");
        }
      } catch (error) {
        if (loadingMessage && loadingMessage.parentNode) {
          loadingMessage.remove();
        }
        console.error("Error completo:", error);
        showError(`Error: ${error.message}`);
      }
    }

    // Event listeners
    console.log("🔹 Registrando event listeners..."); // DEBUG

    sendButton.addEventListener("click", function (e) {
      console.log("🖱️ Click en botón detectado"); // DEBUG
      e.preventDefault();
      sendMessage();
    });

    messageInput.addEventListener("keydown", function (event) {
      console.log("⌨️ Tecla presionada:", event.key); // DEBUG
      if (event.key === "Enter") {
        event.preventDefault();
        console.log("✅ Enter detectado, ejecutando sendMessage"); // DEBUG
        sendMessage();
      }
    });

    console.log("✅ Event listeners registrados correctamente"); // DEBUG
  </script>
</html>
