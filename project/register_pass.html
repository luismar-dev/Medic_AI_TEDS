<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register Password</title>
    <link rel="stylesheet" href="register.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
  </head>

  <body>
    <div class="container">
      <div
        id="expired-message"
        style="display: none; text-align: center; color: white; padding: 40px"
      >
        <h1>Enlace Expirado ⏱️</h1>
        <p style="margin-top: 15px; font-size: 18px">
          Este enlace de verificación era válido por 5 minutos y ha caducado.
        </p>
        <p style="margin-top: 20px">
          Por favor, regresa al formulario de registro para solicitar un nuevo
          correo.
        </p>
        <a
          href="form_page.html"
          style="
            display: inline-block;
            margin-top: 30px;
            padding: 15px 30px;
            background-color: #a057d5;
            color: #131313;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
          "
        >
          Volver al Registro
        </a>
      </div>

      <div class="header">
        <h1>Crear contraseña</h1>
      </div>

      <div class="form-group">
        <label for="contra">Contraseña</label>
        <div class="input-password-container">
          <input
            type="password"
            id="contra"
            placeholder=""
            onblur="validarCampo('contra')"
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('contra', 'toggleIcon1')"
          >
            <i class="fas fa-eye-slash" id="toggleIcon1"></i>
          </span>
        </div>
        <span class="error-msg" id="error-contra"></span>
      </div>

      <div class="form-group">
        <label for="confirm-contra">Confirmar Contraseña</label>
        <div class="input-password-container">
          <input
            type="password"
            id="confirm-contra"
            placeholder=""
            onblur="validarCampo('confirm-contra')"
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('confirm-contra', 'toggleIcon2')"
          >
            <i class="fas fa-eye-slash" id="toggleIcon2"></i>
          </span>
        </div>
        <span class="error-msg" id="error-confirm"></span>
      </div>

      <div class="form-group terms-group">
        <div class="terms">
          <input type="checkbox" id="acepto" onchange="validarTerminos()" />
          <label for="acepto">He leído y acepto el aviso de privacidad</label>
          <span class="open-modal-arrow" onclick="openPrivacyModal()"></span>
        </div>
        <span class="error-msg" id="error-acepto"></span>
      </div>
      <div class="register-btn">
        <button type="button" onclick="validarTodoFormulario()">
          Registrar
        </button>
      </div>
    </div>

    <div id="privacyModal" class="modal modal-privacy" aria-hidden="true">
      <div
        class="modal-content modal-privacy-content"
        role="dialog"
        aria-modal="true"
      >
        <span
          class="close-btn"
          onclick="closePrivacyModal()"
          aria-label="Cerrar Aviso"
          >&times;</span
        >
        <h2 class="modal-title-privacy">Aviso de Privacidad</h2>
        <div class="modal-body modal-privacy-body">
          <p class="modal-text-strong">**POLÍTICA DE PRIVACIDAD**</p>
          <p>
            La presente Política de Privacidad establece los términos en que
            Medic-AI usa y protege la información que es proporcionada por sus
            usuarios al momento de utilizar su sitio web. Medic-AI está
            comprometida con la seguridad de los datos de sus usuarios. Cuando
            le pedimos llenar los campos de información personal con la cual
            usted pueda ser identificado, lo hacemos asegurando que sólo se
            empleará de acuerdo con los términos de este documento.
          </p>
          <p class="modal-text-strong">**Información que es recogida**</p>
          <p>
            Nuestro sitio web podrá recoger información personal por ejemplo:
            Nombre, información de contacto como su dirección de correo
            electrónico, edad, sexo, enfermedades crónicas y hábitos.
          </p>
          <p class="modal-text-strong">**Uso de la información recogida**</p>
          <p>
            Nuestro sitio web emplea la información con el fin de proporcionar
            el mejor servicio posible y particularmente para mantener un
            registro de usuarios y personalizar las recomendaciones médicas de
            nuestra IA.
          </p>
          <p>
            Medic-AI está altamente comprometido para cumplir con el compromiso
            de mantener su información segura. Usamos los sistemas más avanzados
            y los actualizamos constantemente para asegurarnos que no exista
            ningún acceso no autorizado.
          </p>
          <p>
            Medic-AI Se reserva el derecho de cambiar los términos de la
            presente Política de Privacidad en cualquier momento.
          </p>
        </div>
        <button
          type="button"
          class="btn-accept-privacy"
          onclick="acceptAndClosePrivacyModal()"
        >
          Aceptar y Cerrar
        </button>
      </div>
    </div>
    <script>
      const formContainer = document.querySelector(".container");
      const expiredMessageDiv = document.getElementById("expired-message");

      const urlParams = new URLSearchParams(window.location.search);
      const usuario = {
        nombre: urlParams.get("nombre"),
        email: urlParams.get("email"),
        edad: urlParams.get("edad"),
        sexo: urlParams.get("sexo"),
        enfermedades: urlParams.get("enfermedades"),
        habitos: urlParams.get("habitos"),
      };

      const linkTimestamp = parseInt(urlParams.get("timestamp"), 10);

      // Calcular el tiempo del enlace
      const nowTimestamp = Math.floor(Date.now() / 1000);
      const linkAgeInSeconds = nowTimestamp - linkTimestamp;
      const expirationTimeInSeconds = 5 * 60;
      console.log("Buscando el div de mensaje:", expiredMessageDiv);

      // Comprobar si el enlace es válido
      if (!linkTimestamp || linkAgeInSeconds > expirationTimeInSeconds) {
        formContainer.style.display = "none";
        expiredMessageDiv.style.display = "block";
      } else {
        console.log(
          `El enlace tiene ${linkAgeInSeconds} segundos de antigüedad. Aún es válido.`
        );
      }

      if (usuario.email) {
        console.log("Email recibido:", usuario.email);
      } else {
        console.log("No se recibió email en la URL");
        alert(
          "Error: No se recibió el email. Por favor, regresa al formulario de registro."
        );
      }

      const regexCaracteres = /^[a-zA-Z0-9@#$%&!?*._-]*$/;
      const API_URL = "http://127.0.0.1:5000/api";

      function validarContrasenaPrincipal() {
        const contrasena = document.getElementById("contra").value.trim();
        const errorElemento = document.getElementById("error-contra");
        let esValido = true;

        errorElemento.textContent = "";
        errorElemento.style.opacity = "0";

        if (contrasena.length === 0) {
          errorElemento.textContent = "El campo de Contraseña es obligatorio.";
          errorElemento.style.opacity = "1";
          esValido = false;
        } else if (contrasena.length < 8) {
          errorElemento.textContent =
            "La contraseña debe tener un mínimo de 8 caracteres.";
          errorElemento.style.opacity = "1";
          esValido = false;
        } else if (!regexCaracteres.test(contrasena)) {
          errorElemento.textContent =
            "Solo se permiten letras, números y @ # $ % & ! ? * . _ -";
          errorElemento.style.opacity = "1";
          esValido = false;
        }
        return esValido;
      }

      function validarConfirmacion() {
        const contrasena = document.getElementById("contra").value.trim();
        const confirmacion = document
          .getElementById("confirm-contra")
          .value.trim();
        const errorElemento = document.getElementById("error-confirm");
        let esValido = true;

        errorElemento.textContent = "";
        errorElemento.style.opacity = "0";

        if (confirmacion.length === 0) {
          errorElemento.textContent =
            "El campo de Confirmar Contraseña es obligatorio.";
          errorElemento.style.opacity = "1";
          esValido = false;
        } else if (contrasena !== confirmacion) {
          errorElemento.textContent = "Las contraseñas no coinciden.";
          errorElemento.style.opacity = "1";
          esValido = false;
        }
        return esValido;
      }

      function validarTerminos() {
        const acepto = document.getElementById("acepto").checked;
        const errorElemento = document.getElementById("error-acepto");

        errorElemento.textContent = "";
        errorElemento.style.opacity = "0";

        let esValido = true;
        if (!acepto) {
          errorElemento.textContent = "Debes aceptar el aviso de privacidad.";
          errorElemento.style.opacity = "1";
          esValido = false;
        }
        return esValido;
      }

      function validarCampo(campoId) {
        if (campoId === "contra") {
          const contraValida = validarContrasenaPrincipal();
          if (contraValida) {
            validarConfirmacion();
          }
        } else if (campoId === "confirm-contra") {
          validarConfirmacion();
        }
      }

      async function guardarContrasena(email, contrasena) {
        try {
          const response = await fetch(`${API_URL}/actualizar-contrasena`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: email,
              contrasena: contrasena,
            }),
          });

          const resultado = await response.json();

          if (!response.ok) {
            throw new Error(
              resultado.error || "Error al guardar la contraseña"
            );
          }

          return resultado;
        } catch (error) {
          console.error("Error al guardar contraseña:", error);
          throw error;
        }
      }

      async function validarTodoFormulario() {
        const validaContra = validarContrasenaPrincipal();
        const validaConfirm = validarConfirmacion();
        const validaTerminos = validarTerminos();

        const esValido = validaContra && validaConfirm && validaTerminos;

        if (esValido) {
          // Verificar que tenemos el email
          if (!email) {
            alert(
              "Error: No se pudo obtener el email. Por favor, regresa al formulario de registro."
            );
            return false;
          }

          const confirmBtn = document.querySelector(".register-btn button");
          const originalText = confirmBtn.textContent;

          try {
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Guardando...";

            const contrasena = document.getElementById("contra").value.trim();

            // Guardar contraseña en la base de datos
            console.log(" Guardando contraseña...");
            await guardarContrasena(email, contrasena);

            console.log(" Contraseña guardada exitosamente");
            alert("¡Contraseña creada con éxito! Tu cuenta ha sido activada.");
          } catch (error) {
            console.error("❌ Error al guardar contraseña:", error);
            alert(
              "Error al guardar la contraseña. Por favor, inténtalo de nuevo."
            );
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
          }
        }

        return esValido;
      }

      function openPrivacyModal() {
        const modal = document.getElementById("privacyModal");
        modal.style.display = "flex";
        modal.setAttribute("aria-hidden", "false");
      }

      function closePrivacyModal() {
        const modal = document.getElementById("privacyModal");
        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");
      }

      function acceptAndClosePrivacyModal() {
        const aceptoCheckbox = document.getElementById("acepto");
        aceptoCheckbox.checked = true;
        validarTerminos();
        closePrivacyModal();
      }

      function togglePasswordVisibility(campoId) {
        const passwordInput = document.getElementById(campoId);
        const toggleIcon = passwordInput.nextElementSibling;
        const iconElement = toggleIcon.querySelector("i");

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          if (iconElement) {
            iconElement.classList.remove("fa-eye-slash");
            iconElement.classList.add("fa-eye");
          }
        } else {
          passwordInput.type = "password";
          if (iconElement) {
            iconElement.classList.remove("fa-eye");
            iconElement.classList.add("fa-eye-slash");
          }
        }
      }

      async function registrarCuentaCompleta() {
        const validaContra = validarContrasenaPrincipal();
        const validaConfirm = validarConfirmacion();
        const validaTerminos = validarTerminos();

        if (validaContra && validaConfirm && validaTerminos) {
          const confirmBtn = document.querySelector(".register-btn button");
          confirmBtn.disabled = true;
          confirmBtn.textContent = "Guardando...";

          try {
            usuario.contrasena = document.getElementById("contra").value.trim();

            const response = await fetch(`${API_URL}/crear-cuenta-completa`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(usuario),
            });

            const resultado = await response.json();
            if (!response.ok) {
              throw new Error(resultado.error || "Error al crear la cuenta");
            }

            alert(
              "¡Cuenta creada con éxito! Redirigiendo a la página de inicio..."
            );

            setTimeout(() => {
              window.location.href = "sesion.html";
            }, 2000);
          } catch (error) {
            console.error("❌ Error al crear la cuenta:", error);
            alert("Error al crear la cuenta. Por favor, inténtalo de nuevo.");
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = "Confirmar";
          }
        }
      }

      // Event listener para el botón de confirmar
      document.addEventListener("DOMContentLoaded", () => {
        const confirmBtn = document.querySelector(".register-btn button");

        if (confirmBtn) {
          confirmBtn.addEventListener("click", (e) => {
            e.preventDefault();
            registrarCuentaCompleta();
          });
        }
      });
    </script>
  </body>
</html>
